<!DOCTYPE html>
<html>
<head>
  <title>Hydrology AI Tool</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
  />

  <!-- Our custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

  <!-- Header / Dashboard -->
  <header class="top-header">
    <h1>Hydrology AI Tool</h1>
    <button id="draw-polygon-btn">Draw a Polygon</button>
  </header>

  <!-- Page Layout: Map and Sidebar -->
  <div class="page-container">
    <!-- Map Container -->
    <div id="map"></div>

    <!-- Station Info Sidebar -->
    <div id="station-list">
      <div class="sidebar-section">
        <div class="section-header" onclick="toggleSection(this)">
          ▶ View
        </div>
        <div class="section-content">
          <div class="subsection">
            <strong>Flood Susceptibility Mapping</strong><br>
            <button class="view-btn">View</button>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <div class="section-header" onclick="toggleSection(this)">
          ▶ Tools
        </div>
        <div class="section-content">
          <div class="subsection" style="color: #777;">Coming soon...</div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <div class="section-header" onclick="toggleSection(this)">
          ▶ Resulted Stations
        </div>
        <div class="section-content">
          <ul id="station-items"></ul>
        </div>
      </div>
      
      
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script>
    var map = L.map('map').setView([20, 0], 2);
  
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);
  
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
  
    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polyline: false,
        rectangle: false,
        circle: false,
        circlemarker: false,
        marker: false,
        polygon: true
      }
    });
    map.addControl(drawControl);
  
    map.on(L.Draw.Event.CREATED, function (e) {
      drawnItems.clearLayers();
      var layer = e.layer;
      drawnItems.addLayer(layer);
  
      const latlngs = layer.getLatLngs()[0];
      const coordinates = latlngs.map(p => [p.lng, p.lat]);
  
      document.getElementById("station-items").innerHTML = "";
  
      fetch("http://127.0.0.1:5002/api/stations-in-polygon", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ coordinates: coordinates })
      })
      .then(res => res.json())
      .then(data => {
        console.log("Stations:", data);
  
        data.forEach(station => {
          // Map Marker
          L.marker([station.lat, station.lng])
            .addTo(map)
            .bindPopup(`<b>${station.name}</b>`);
  
          // Sidebar
          const li = document.createElement("li");
          let linksHTML = "<p style='font-size: 0.9rem; color: #777;'>No data links available.</p>";
  
          if (Array.isArray(station.links) && station.links.length > 0) {
            linksHTML = `
              <ul>
                ${station.links.map(link => `
                  <li>
                    <a href="${link.url}" target="_blank">${link.label}</a>
                    <span style="color: #666; font-size: 0.85rem;"> (${link.type})</span>
                  </li>
                `).join('')}
              </ul>
            `;
          }
  
          li.innerHTML = `
            <strong>${station.name}</strong>
            ${linksHTML}
          `;
          document.getElementById("station-items").appendChild(li);
        });
      });
    });
  
    document.getElementById('draw-polygon-btn').addEventListener('click', function () {
      const drawToolbar = document.querySelector('.leaflet-draw-toolbar a.leaflet-draw-draw-polygon');
      if (drawToolbar) {
        drawToolbar.click();
      }
    });
  </script>
  <script>
    function toggleSection(headerEl) {
      const content = headerEl.nextElementSibling;
      const isOpen = headerEl.classList.toggle("open");
  
      if (isOpen) {
        content.style.maxHeight = content.scrollHeight + "px";
        headerEl.innerHTML = headerEl.innerHTML.replace("▶", "▼");
      } else {
        content.style.maxHeight = null;
        headerEl.innerHTML = headerEl.innerHTML.replace("▼", "▶");
      }
    }
  </script>
  
</body>
</html>
